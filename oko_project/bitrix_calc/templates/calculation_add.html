<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Конфигуратор изделий</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f4f4f9;
        }

        .container {
            display: flex;
            width: 80%;
            height: 80%;
            border: 1px solid #ccc;
            background-color: #fff;
        }

        .item-list, .item-types, .item-details {
            padding: 20px;
            overflow-y: auto;
        }

        .item-list {
            width: 20%;
            border-right: 1px solid #ccc;
        }

        .item-types {
            width: 20%;
            border-right: 1px solid #ccc;
        }

        .item-details {
            width: 60%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .item-list ul, .item-types ul {
            list-style: none;
            padding: 0;
        }

        .item-list li, .item-types li {
            cursor: pointer;
            padding: 5px;
            border-radius: 3px;
            transition: background-color 0.3s, color 0.3s;
        }

        .item-list li:hover, .item-types li:hover {
            background-color: #ddd;
        }

        .hidden {
            display: none;
        }

        /* Стили для nameTypeElement */
        .name-type {
            cursor: pointer;
            font-weight: bold;
            padding: 8px;
            border-radius: 3px;
            transition: background-color 0.3s, color 0.3s;
        }

        .name-type:hover {
            background-color: #f0f0f0;
        }

        /* Активный элемент */
        .name-type.active {
            background-color: #007bff;
            color: white;
        }

        .name-type ul {
            margin-top: 5px;
            margin-left: 20px;
            padding-left: 0;
            list-style: none;
        }
            .inner_name-type.selected {
            background-color: #007bff;
            color: white;
            font-weight: bold;
        }
        .image-frame {
            width: 80%;
            height: 50%;
            border: 1px solid #ccc;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            background-color: #f9f9f9;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            width: 80%;
        }

        .input-group label {
            margin-top: 10px;
            font-weight: bold;
        }

        .input-group input {
            padding: 5px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }

        .submit-button {
            margin-top: 20px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        .submit-button:hover {
            background-color: #218838;
        }
    </style>
</head>
<body>

<div class="container">
    <!-- Список изделий -->
    <div class="item-list">
        <h3>Список изделий</h3>
        <ul id="productList">
            {% for good in goods %}
                <li data-product-id="{{ good.id }}" data-name="{{ good.bitrix_goods_name }}" onclick="loadItemTypes(this)">{{ good.bitrix_goods_name }}</li>
            {% endfor %}
        </ul>
    </div>

    <!-- Виды изделий -->
    <div class="item-types">
        <h3>Виды изделий</h3>
        <ul id="itemTypesList">
            <!-- Виды товаров загружаются динамически -->
        </ul>
    </div>

    <!-- Детали изделия -->
    <div class="item-details">
        <div class="image-frame">
            Картинка выбранного изделия
        </div>
        <div id='paramsContainer' class="input-group">
        </div>
        <div id='PriceContainer'>
        </div>
        <button class="submit-button" onclick="createDealInBitrix()">Создать</button>
    </div>
</div>
<div class="client-search">
    <h3>Поиск клиента</h3>
    <div class="input-group">
        <label for="clientSearch">Поиск клиента:</label>
        <input type="text" id="clientSearch" oninput="filterClients()" placeholder="Введите имя или email">
    </div>
    <ul id="clientList"></ul>
    <button id="getUserNameButton">Получить имя</button>
</div>
<script>
    let selectedProductId = null;
let selectedProductName = null;

function loadItemTypes(element) {
    const productId = element.getAttribute("data-product-id");
    const productName = element.getAttribute("data-name");
    selectedProductId = productId;
    selectedProductName = productName;

    const itemTypesList = document.getElementById("itemTypesList");

    // Если виды уже отображаются для текущего продукта, скрываем их
    if (element.classList.contains("active")) {
        itemTypesList.innerHTML = ""; // Очищаем список видов
        element.classList.remove("active");
        return;
    }

    // Убираем активный класс с других продуктов
    const productListItems = document.querySelectorAll("#productList li");
    productListItems.forEach(item => item.classList.remove("active"));

    // Добавляем активный класс для текущего продукта
    element.classList.add("active");

    // Загружаем данные через AJAX
    fetch(`/get-item-types/${productId}/`)
        .then(response => response.json())
        .then(data => {
            // Очищаем список видов перед добавлением новых
            itemTypesList.innerHTML = "";

            for (const [nameType, types] of Object.entries(data)) {
                const nameTypeElement = document.createElement("li");
                nameTypeElement.classList.add("name-type");
                nameTypeElement.textContent = nameType;

                const typeList = document.createElement("ul");
                typeList.classList.add("hidden");

                types.forEach(type => {
                    const typeElement = document.createElement("li");
                    typeElement.textContent = type;
                    typeElement.classList.add("inner_name-type");  // Adding the class
                    typeElement.onclick = () => toggleSelection(type, nameType, typeElement); // Adding the click handler
                    typeList.appendChild(typeElement);
                });


                // Добавляем nameTypeElement и typeList как отдельные элементы
                itemTypesList.appendChild(nameTypeElement);
                itemTypesList.appendChild(typeList);

                // Однократный клик для открытия списка типов
                nameTypeElement.onclick = () => toggleTypes(typeList);
                // Двойной клик для сворачивания всех видов этого продукта
                nameTypeElement.ondblclick = () => collapseProductTypes();
            }
        })
        .catch(error => console.error("Ошибка загрузки видов товаров:", error));
}

function toggleTypes(typeList) {
    if (typeList.classList.contains("hidden")) {
        typeList.classList.remove("hidden");
    } else {
        typeList.classList.add("hidden");
    }
}

function collapseProductTypes() {
    const itemTypesList = document.getElementById("itemTypesList");
    itemTypesList.innerHTML = ""; // Скрыть все виды товаров для текущего продукта
}

// Массив для хранения всех выбранных элементов
let selectedItems = [];

// Управление выделением элементов
function toggleSelection(type, nameType, typeElement) {
    console.log('клик' + type, nameType, typeElement);
    if (!typeElement) {
        console.error('Element is null or undefined');
        return;
    }

    // Переключаем выделение элемента
    if (typeElement.classList.contains('selected')) {
        typeElement.classList.remove('selected');
    } else {
        typeElement.classList.add('selected');
    }

    // Обновляем параметры для всех выбранных элементов
    fetchParametersForSelectedTypes(nameType);
}

// Обновление параметров для всех выделенных элементов
function fetchParametersForSelectedTypes(nameType) {
    const parametersProductContainer = document.getElementById('paramsContainer');

    // Собираем все выделенные типы товаров и их родителей
    const selectedTypes = Array.from(document.querySelectorAll('.inner_name-type.selected'))
        .map(li => {
            const parentLi = li.closest('ul').previousElementSibling; // Ищем предыдущий элемент <li class="name-type">
            return {
                type: li.textContent.trim(),
                parent: parentLi ? parentLi.textContent.trim() : '' // Получаем текст родителя
            };
        });

    console.log("Выбранные типы товаров с родителями:", selectedTypes);

    // Формируем запрос с передачей всех выделенных типов и их родителей
    const url = selectedTypes.length > 0
        ? `/api/parameters_product_bitrix/?goods_id=${selectedProductId}&bitrix_goods_name=${selectedProductName}&name_type_of_goods=${nameType}&selected_types=${JSON.stringify(selectedTypes)}`
        : `/api/parameters_product_bitrix/?goods_id=${selectedProductId}&bitrix_goods_name=${selectedProductName}&name_type_of_goods=${nameType}`;

    fetch(url)
        .then(response => response.json())
        .then(data => {
            parametersProductContainer.innerHTML = ''; // Очищаем контейнер с параметрами

            if (data.parameters && Array.isArray(data.parameters)) {
                // Создаем форму с параметрами
                data.parameters.forEach(param => {
                    const label = document.createElement('label');
                    label.innerHTML = `
                        <span>${param.name}:</span>
                        <input type="text" name="${param.name}" value="" placeholder="Введите значение для ${param.name}">
                    `;
                    const inputField = label.querySelector('input');
                    inputField.addEventListener('input', () => {
                        sendParameterDataToServer();
                    });
                    parametersProductContainer.appendChild(label);
                    parametersProductContainer.appendChild(document.createElement('br'));
                });
            } else {
                parametersProductContainer.innerHTML = '<p>Нет параметров для отображения.</p>';
            }
        })
        .catch(error => {
            console.error("Ошибка при загрузке параметров:", error);
            parametersProductContainer.innerHTML = '<p>Произошла ошибка при загрузке параметров.</p>';
        });
}


function submitForm() {
    const width = document.getElementById("width").value;
    const height = document.getElementById("height").value;
    alert(`Создано изделие с размерами: ширина - ${width}, высота - ${height}`);
}

function sendParameterDataToServer(){
    const productParameters = Array.from(document.querySelectorAll('#paramsContainer input'))
        .reduce((params, input) => {
            if (input.value) {
                params[input.name] = parseFloat(input.value) || input.value;
            }
            return params;
        }, {});
    console.log(productParameters)
    const selectedTypes = Array.from(document.querySelectorAll('.inner_name-type.selected'))
        .map(li => {
            const parentLi = li.closest('ul').previousElementSibling; // Ищем предыдущий элемент <li class="name-type">
            return {
                type: li.textContent.trim(),
                parent: parentLi ? parentLi.textContent.trim() : '' // Получаем текст родителя
            };
        });
    console.log(selectedTypes)
    const parentUl = document.querySelector('#productList'); // Select the <ul> element with id="productList"
    const activeLi = parentUl.querySelector('li.active'); // Select the <li> element with class="active" inside <ul>

    const selectedProductId = activeLi ? activeLi.getAttribute('data-product-id') : null; // Get the value of data-product-id
    fetch('/api/update_parameters_product_bitrix/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            product_parameters: productParameters,
            selectedTypes: selectedTypes,
            selectedProductId: selectedProductId
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log(data)
    const container2 = document.getElementById('PriceContainer');
    container2.innerHTML = ''; // Очищаем контейнер перед выводом новых данных
    const finalPriceElement = document.createElement('div');
        finalPriceElement.textContent = `Общая стоимость: ${Math.floor(data.total_final_price)} руб.`;
        container2.appendChild(finalPriceElement);
        console.log(`Итоговая Цена: ${data.total_final_price} руб.`)
    // if (data.success) {
    //     // Проверяем, получены ли данные по операциям
    //     // if (nomenclaturePrice && data.operations.length > 0) {
    //     data.operations.forEach(operation => {
    //         // Создаем новый элемент для каждой операции
    //         const operationElement = document.createElement('div');
            
    //         // Форматируем цену для текущей операции
    //         const finalPrice = Math.floor(operation.final_price);
    //         operationElement.textContent = `Операция: ${operation.operation}, Цена: ${finalPrice} руб.`;

    //         // Добавляем элемент в контейнер
    //         container2.appendChild(operationElement);
    //     });
    //     // } else {
    //     //     container2.textContent = 'Цена не найдена';
    //     // }
    // } else {
    //     console.error('Ошибка при обновлении параметров:', data.message);
    //     container2.textContent = 'Параметр в цене не выбран';
    // }
})
.catch(error => {
    console.error('Error sending parameter data to server:', error);
});
}





// function updateFinalPrice(productParameters) {
//     console.log('updateFinalPrice');


//     fetch('/api/update_parameters/', {
//         method: 'POST',
//         headers: {
//             'Content-Type': 'application/json',
//             'X-CSRFToken': '{{ csrf_token }}'
//         },
//         body: JSON.stringify({
//             product_parameters: productParameters,            
//         })
//     })
//     .then(response => response.json())
//     .then(data => {
//     const container2 = document.getElementById('price-container2');
//     container2.innerHTML = ''; // Очищаем контейнер перед выводом новых данных

//     if (data.success) {
//         // Проверяем, получены ли данные по операциям
//         if (nomenclaturePrice && data.operations.length > 0) {
//             data.operations.forEach(operation => {
//                 // Создаем новый элемент для каждой операции
//                 const operationElement = document.createElement('div');
                
//                 // Форматируем цену для текущей операции
//                 const finalPrice = Math.floor(operation.final_price);
//                 operationElement.textContent = `Операция: ${operation.operation}, Цена: ${finalPrice} руб.`;

//                 // Добавляем элемент в контейнер
//                 container2.appendChild(operationElement);
//             });
//         } else {
//             container2.textContent = 'Цена не найдена';
//         }
//     } else {
//         console.error('Ошибка при обновлении параметров:', data.message);
//         container2.textContent = 'Параметр в цене не выбран';
//     }
// })
// .catch(error => {
//     console.error('Error sending parameter data to server:', error);
// });

// }



// getUserCurrent();
// Функция для загрузки списка клиентов

function createDealInBitrix() {
    const container = document.getElementById('PriceContainer');
    const priceText = container.textContent;
    const price = priceText ? parseFloat(priceText.replace('Общая стоимость: ', '')) : null;
    console.log(price)
    if (!price) {
        alert('Цена не найдена, невозможно создать сделку');
        return;
    }

    fetch('/create-deal/', {  // URL эндпоинта вашего Django-приложения
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken(),  // Убедитесь, что CSRF-токен передается
        },
        body: JSON.stringify({ price: price })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Ответ от сервера:', data);
        if (data.deal_id) {
            alert('Сделка успешно создана! ID сделки: ' + data.deal_id);
        } else {
            alert('Ошибка при создании сделки: ' + (data.error || 'Неизвестная ошибка'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Произошла ошибка при создании сделки.');
    });
}
function getCsrfToken() {
    // Функция для получения CSRF-токена
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'csrftoken') {
            return value;
        }
    }
    return '';
}

function getUserCurrent() {
        fetch('/api/user-current/', {
            method: 'GET',
            headers: {
                'X-CSRFToken': getCsrfToken(),
            },
        })
        .then(response => response.json())
        .then(data => {
            console.log(data)
            if (data.user_name) {
                alert('Имя пользователя: ' + data.user_name); // Выводим имя пользователя в alert
            } else {
                console.log('Ошибка получения данных:', data.error);
            }
        })
        .catch(error => {
            console.error('Ошибка запроса:', error);
        });
    }
// function getUserCurrent() {
//         fetch('/api/user-current/', {
//             method: 'GET',
//             headers: {
//                 'X-CSRFToken': getCsrfToken(),
//             },
//         })
//         .then(response => response.json())
//         .then(data => {
//             if (data.user_info) {
//                 console.log('Информация о пользователе:', data.user_info);
//                 alert('Имя пользователя: ' + data.user_info.name); // Выводим имя пользователя в alert
//             } else if (data.authorization_url) {
//                 // Сохраняем текущий URL
//                 const authButton = document.createElement('button');
//                 authButton.textContent = 'Открыть страницу авторизации';
//                 authButton.style.padding = '10px 20px';
//                 authButton.style.fontSize = '16px';
//                 authButton.style.margin = '20px';
//                 authButton.style.cursor = 'pointer';

//                 authButton.addEventListener('click', () => {
//                     window.open(data.authorization_url, '_blank');
//                 });

//                 const body = document.querySelector('body');
//                 body.innerHTML = '';
//                 body.appendChild(authButton);
//             } else {
//                 console.log('Ошибка получения данных:', data.error);
//             }
//         })
//         .catch(error => {
//             console.error('Ошибка запроса:', error);
//         });
//     }

    // Обработчик клика по кнопке "Получить имя"
    document.getElementById('getUserNameButton').addEventListener('click', getUserCurrent);



// Вызов функции при загрузке страницы


</script>

</body>
</html>
