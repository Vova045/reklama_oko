<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Bitrix Integration</title>
    
    <script src="//api.bitrix24.com/api/v1/"></script>
    <script>
        BX24.init(function() {
            const initData = BX24.getAuth();
            console.log("initData: ", initData);
    
            if (!initData.access_token) {
                console.error("Access token not found.");
                return;
            }
    
            bindApplication(initData.access_token);  // Вызываем функцию связывания
        });
    
        function bindApplication(accessToken) {
            const url = '/api/bitrix/bind/?access_token=' + accessToken;
    
            fetch(url, {
                method: 'POST',
            })
            .then(response => {
                console.log("Response status:", response.status);
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error('Network response was not ok: ' + JSON.stringify(errorData));
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log("Результат связывания:", data);
                alert("Ссылка на приложение добавлена в меню сделок!");
            })
            .catch(error => {
                console.error("Ошибка при добавлении ссылки:", error);
                alert("Ошибка при добавлении ссылки: " + error.message);
            });
        }
    
        function fetchAvailablePlacements() {
    const accessToken = BX24.getAuth().access_token;

    if (!accessToken) {
        console.error("Access token is not available.");
        return;
    }

    const url = `https://reklamaoko.ru/api/bitrix/get_available_placements/?access_token=${accessToken}`;

    fetch(url)
        .then(response => {
            if (!response.ok) {
                throw new Error("Network response was not ok: " + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            displayAvailablePlacements(data.available_placements);
        })
        .catch(error => {
            console.error("Ошибка при получении доступных размещений:", error);
            alert("Ошибка: " + error.message);
        });
}

function displayAvailablePlacements(placements) {
    // Получаем элемент для отображения мест
    const placementsContainer = document.getElementById("placements-container");

    // Очищаем контейнер перед добавлением новых данных
    placementsContainer.innerHTML = "";

    // Проверяем, есть ли размещения
    if (placements && placements.length > 0) {
        placements.forEach(placement => {
            // Создаем элемент для каждого размещения
            const placementItem = document.createElement("div");
            placementItem.textContent = placement; // Устанавливаем текст размещения
            placementsContainer.appendChild(placementItem); // Добавляем элемент в контейнер
        });
    } else {
        placementsContainer.textContent = "Размещений не найдено."; // Если размещений нет
    }
}

// Вызываем функцию при загрузке страницы
document.addEventListener("DOMContentLoaded", fetchAvailablePlacements);


function managePlacements() {
    // Получение токена авторизации
    const accessToken = BX24.getAuth().access_token;

    if (!accessToken) {
        console.error("Access token is not available.");
        return;
    }

    // Отображение access token на странице
    document.getElementById("access-token").textContent = `Access Token: ${accessToken}`;

    // URL и данные для удаления и добавления размещений
    const removeUrl = `https://reklamaoko.ru/api/bitrix/unbind_placements/?access_token=${accessToken}`;
    const addUrl = `https://reklamaoko.ru/api/bitrix/bind_placements/?access_token=${accessToken}`;

    // Функция для удаления всех текущих размещений
    fetch(removeUrl)
        .then(response => {
            if (!response.ok) {
                throw new Error("Error removing placements: " + response.statusText);
            }
            return response.json();
        })
        .then(() => {
            console.log("Все размещения успешно удалены.");
            // После удаления добавляем новое размещение
            return fetch(addUrl);
        })
        .then(response => {
            if (!response.ok) {
                throw new Error("Error adding placement: " + response.statusText);
            }
            return response.json();
        })
        .then(data => {
            displayAddedPlacement(data.placement);
        })
        .catch(error => {
            console.error("Ошибка при управлении размещениями:", error);
            alert("Ошибка: " + error.message);
        });
}

// Функция для отображения добавленного размещения
function displayAddedPlacement(placement) {
    const placementsContainer = document.getElementById("placements-container");
    placementsContainer.innerHTML = ""; // Очистка контейнера
    const placementItem = document.createElement("div");
    placementItem.textContent = `Добавленное размещение: ${placement}`;
    placementsContainer.appendChild(placementItem);
}

// Запуск функции при загрузке страницы
document.addEventListener("DOMContentLoaded", managePlacements);


    </script>
    
    
</head>
<body>
    <h1>Управление размещениями в Bitrix24</h1>
    <div id="access-token"></div> <!-- Контейнер для access token -->
    <div id="placements-container"></div> <!-- Контейнер для добавленных размещений -->
</body>
</html>
